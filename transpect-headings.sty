%%
%% This is file `transpect-headings.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% transpect.dtx  (with options: `headings')
%% 
%% IMPORTANT NOTICE:
%% 
%% For the copyright see the source file.
%% 
%% Any modified versions of this file must be renamed
%% with new filenames distinct from transpect-headings.sty.
%% 
%% For distribution of the original source see the terms
%% for copying and modification in the file transpect.dtx.
%% 
%% This generated file may be distributed as long as the
%% original source files, as listed above, are part of the
%% same distribution. (The sources need not necessarily be
%% in the same archive or directory.)
\def\fileversion{0.97}%
\def\filedate{2021-02-25}%
%%
%% module for le-tex transpect.cls that extends heading objects.
%%
%% Maintainer: p.schulz@le-tex.de
%%
%% lualatex  -  texlive >= 2019
%%
\NeedsTeXFormat{LaTeX2e}[2019/01/01]
\ProvidesPackage{transpect-headings}
    [\filedate \fileversion le-tex transpect headings module]
\RequirePackage{transpect-common}
\RequirePackage{bookmark}
\hypersetup{bookmarksdepth=-999}
\long\def\tpDeclareHeading{\@ifnextchar[{\@tpDeclareHeading}{\@tpDeclareHeading[]}}%]
\long\def\@tpDeclareHeading[#1]#2#3#4{%
  \tpNamespace{heading}%
  \expandafter\def\csname heading@#3@name\endcsname{#3}%
  %
  \if!#1!\else\expandafter\protect\expandafter\def\csname tp@heading@#3@parent\endcsname{#1}\fi%
  \expandafter\protect\expandafter\def\csname tp@heading@#3@properties\endcsname{#4}%
  \tp@init@l@{#2}{#3}%
  %
  %
  %
  \expandafter\def\csname tpUseHeading#3\endcsname{%
    \if!#1!\else\edef\tp@heading@parent{#1}\fi%
    \edef\tp@heading@level{#2}%
    \@setpar{\@@par}%
    \tpNamespace{heading}%
    \tpCascadeProps{#3}{heading}%
    \def\Hy@toclevel{#2}%
    \tpUseProperty{heading-par}%
    \tpUseProperty{before-heading}%
    \everypar{}%
    \tp@create@labels{#3}% label facility
    \tp@number@props% Calculate number width
    \tp@make@run% Running headers
    \tp@make@toc% ToC entries
    \tp@make@bookmarks% Bookmarks
    \tpIfProp{after-skip}{\expandafter\@tempskipa\expandafter=\tpUseProperty{after-skip}\relax}{\@tempskipa=1sp\relax}%
    \def\@svsec{%
      \tpUseProperty{before-heading-block}%
      {\tpUseProperty{heading-block}}%
      \tpUseProperty{after-heading-block}%
    }%
    \ifdim\@tempskipa <\z@\relax
      \tp@inline@heading
    \else
      \tp@block@heading
    \fi
    \aftergroup\next%
  }}

\def\tp@create@labels#1{%
  \ifx\Hy@MakeCurrentHrefAuto\@undefined\else
    \Hy@MakeCurrentHrefAuto{#1}%
    \Hy@raisedlink{\hyper@anchorstart{\@currentHref}\hyper@anchorend}%
  \fi
  \expandafter\ifx\csname tp@heading@attr@label\endcsname\relax\else
    \tpIfMacro{Number}{%
      \edef\@tempa{\expandonce{\tp@heading@Number}}%
      \let\@currentlabel\@tempa\relax
      \let\@currentlabelname\tp@heading@Title
      \expandafter\ltx@label\expandafter{\tp@heading@attr@label}%
    }{}%
  \fi
  \global\let\label\ltx@label}

\tpAddToDefault{heading}{%
  \tpSetProperty{interline-para}{}%
  \tpSetProperty{heading-par}{%
    \tpIfProp{interline-para}{\if@noskipsec \leavevmode \fi}{}%
    \@@par\global\@afterindenttrue}%
  \tpSetProperty{before-heading}{}%
  \tpSetProperty{title-format}{\bfseries}%
  \tpSetProperty{subtitle-format}{\normalfont}%
  \tpSetProperty{author-format}{\normalfont}%
  \tpSetProperty{quote-format}{\raggedleft}%
  \tpSetProperty{quote-source-format}{}%
  \tpSetProperty{heading-block}{%
    \bgroup
      \tpUseProperty{title-format}%
      \tpIfMacro{Number}{\tpHangNumber{\tpUseProperty{number-width}}}{}%
      {\tpUseMacro{Title}}\par%
      \tpIfMacro{Subtitle}{{\tpUseProperty{subtitle-format}\tpUseMacro{Subtitle}}\par}{}%
      \tpIfMacro{Author}{{\tpUseProperty{author-format}\tpUseMacro{Author}}\par}{}%
      \tpIfMacro{Quote}{%
        \bgroup\tpUseProperty{quote-format}%
          \tpUseMacro{Quote}\par
          \tpIfMacro{QuoteSource}{{\tpUseProperty{quote-source-format}--\space\tpUseMacro{Quote}}\par}{}%
        \egroup}{}%
    \egroup
  }%
  \tpSetProperty{running-heading}{%
    \tpIfMacro{RunAuthor}{\tpUseMacro{RunAuthor}:\space}{}%
    \tpUseMacro{RunTitle}%
  }%
  \tpSetProperty{after-heading-block}{}%
  \tpSetProperty{before-heading-block}{\parindent\z@ \parskip\z@}%
  \tpSetProperty{after-indent}{}%
  \tpSetProperty{after-skip}{1sp}%
  \tpSetProperty{number-sep}{\space}%
  \tpSetProperty{title-format}{\raggedright}%
  \tpSetProperty{number-width}{}%
  %% ToC
  \tpSetProperty{toc-page-sep}{\dotfill}%
  \tpSetProperty{toc-number-width}{}%
  \tpSetProperty{toc-title-format}{}%
  \tpSetProperty{toc-number-format}{\tpUseProperty{toc-title-format}}%
  \tpSetProperty{toc-number-sep}{\enskip}%
  \tpSetProperty{toc-before-entry}{%
    \parindent \z@
    \rightskip \@pnumwidth\@plus1fil\relax
    \parfillskip -\rightskip
  }%
  \tpSetProperty{toc-after-entry}{\par}%
  \tpSetProperty{toc-heading}{%
    \tpIfMacro{TocAuthor}{\tpUseMacro{TocAuthor}:\space}{}%
    {\tpUseProperty{toc-title-format}\tpUseProperty{toc-formatted-number}\tpUseMacro{TocTitle}}%
    \tpUseProperty{toc-page-sep}\tpUseMacro{TocPage}%
  }%
  \tpSetProperty{bookmark}{%
    \tpIfMacro{TocNumber}{\tpUseMacro{TocNumber}\enskip}{}%
    \tpIfMacro{TocTitle}{\tpUseMacro{TocTitle}}{\tpUseMacro{Title}}%
  }%
}

\def\tp@make@toc{%
  \tpIfMacro{TocTitle}{}{\tpIfMacro{Title}{\let\tp@heading@TocTitle\tp@heading@Title}{}}%
  \tpIfMacro{TocNumber}{}{\tpIfMacro{Number}{\let\tp@heading@TocNumber\tp@heading@Number}{}}%
  \tpIfMacro{TocAuthor}{}{\tpIfMacro{Author}{\let\tp@heading@TocAuthor\tp@heading@Author}{}}%
  \tpIfMacro{TocSubtitle}{}{\tpIfMacro{Subtitle}{\let\tp@heading@TocSubtitle\tp@heading@Subtitle}{}}%
  \expandafter\ifx\csname tp@heading@attr@notoc\endcsname\@empty\else
    \edef\tp@heading@toc@entry{%
      \tpIfMacro{TocTitle}{\string\tpTocTitle{\expandonce{\tp@heading@TocTitle}}}{}%
      \tpIfMacro{TocNumber}{\string\tpTocNumber{\expandonce{\tp@heading@TocNumber}}}{}%
      \tpIfMacro{TocAuthor}{\string\tpTocAuthor{\expandonce{\tp@heading@TocAuthor}}}{}%
      \tpIfMacro{TocSubtitle}{\string\tpTocSubtitle{\expandonce{\tp@heading@TocSubtitle}}}{}%
    }%
    \addcontentsline{toc}{\tp@heading@name}{\expandonce{\tp@heading@toc@entry}}\relax
  \fi
}
\def\tp@init@l@#1#2{%
  \ifnum #1>\c@tocdepth
    \expandafter\let\csname l@#2\endcsname\@gobbletwo
  \else
    \expandafter\gdef\csname l@#2\endcsname##1##2{%
      \bgroup
        \tp@toc@extract@data{#1}{#2}{##1}{##2}%
        \begingroup
          \tp@toc@print@entry
        \endgroup
      \egroup
    }%
  \fi
}
\def\tp@toc@extract@data#1#2#3#4{%
  \tpNamespace{heading}%
  \tpCascadeProps{#2}{heading}%
  \tpProvideMacro{tpTocPage}{}{}{TocPage}%
  \tpTocPage{#4}%
  \tpProvideMacro{tpTocTitle}{}{}{TocTitle}%
  \tpProvideMacro{tpTocSubtitle}{}{}{TocSubtitle}%
  \tpProvideMacro{tpTocNumber}{}{}{TocNumber}%
  \tpProvideMacro{tpTocAuthor}{}{}{TocAuthor}%
  \let\tpTocLink\Hy@tocdestname%
  \expandonce#3%% expand toc-specific macros from heading; \expandonce is necessary because of hyperrefâ€¦
  \tp@calc@toc@numbers{#1}%
}
\def\tp@toc@print@entry{%
  \tpUseProperty{toc-before-entry}%
  \tpUseProperty{toc-heading}%
  \tpUseProperty{toc-after-entry}%
}
\def\tp@calc@toc@numbers#1{%
  (#1: \tpUseMacro{TocNumber})
  \tpSetProperty{toc-formatted-number}{}%
  \tpIfMacro{TocNumber}{%
    \tpSetProperty{toc-formatted-number}{%
      \bgroup
        \tpUseProperty{toc-number-format}%
        \tpUseMacro{TocNumber}%
        \tpUseProperty{toc-number-sep}%
      \egroup}}{}%
}

 % \expandafter\tp@calc@numwidth\expandafter{\tp@heading@level}%
\def\tp@calc@numwidth#1{%
  \tpIfPropVal{#1-number-width}{auto-level}
    {\tp@get@toc@numwidth{}}
    {\tpIfPropVal{#1-number-width}{auto}
      {\tp@get@toc@numwidth{}}
      {\tpIfProp{#1-number-width}
        {}
        {}%
      }%
    }%
}%
\def\tp@make@run{%
  \tpIfMacro{RunTitle}{}{\tpIfMacro{Title}{\let\tp@heading@RunTitle\tp@heading@Title}{}}%
  \tpIfMacro{RunNumber}{}{\tpIfMacro{Number}{\let\tp@heading@RunNumber\tp@heading@Number}{}}%
  \tpIfMacro{RunAuthor}{}{\tpIfMacro{Author}{\let\tp@heading@RunAuthor\tp@heading@Author}{}}%
  \tpIfMacro{RunSubTitle}{}{\tpIfMacro{Subtitle}{\let\tp@heading@RunSubtitle\tp@heading@Subtitle}{}}%
  \expandafter\let\expandafter\tp@mark@name\csname\tp@heading@name mark\endcsname%
  \ifx\tp@mark@name\relax\ifx\tp@heading@parent\@undefined\else
      \expandafter\let\expandafter\tp@mark@name\csname\tp@inherit@name mark\endcsname%
    \fi\fi
  \ifx\tp@mark@name\relax\else
    \protected@edef\@tempa{\expandafter\@empty\csname tp@heading@running-heading\endcsname}%
    \expandafter\tp@mark@name\expandafter{\@tempa}%
  \fi}
\def\tp@make@bookmarks{%
  \protected@edef\@tempa{\expandafter\@empty\csname tp@heading@bookmark\endcsname}%
  \bookmark[level=\Hy@toclevel,dest=\@currentHref]{\expandonce{\@tempa}}
}
\def\tp@number@props{%
  \sbox\z@{\tpUseProperty{title-format}\tpUseMacro{Number}\tpUseProperty{number-sep}}\tpSetProperty{number-width}{\the\wd\z@}%
  \def\tpHangNumber##1{\leftskip##1\hskip-##1\hbox to##1{\tpUseProperty{title-format}\tpUseMacro{Number}}}%
}
\def\tp@inline@heading{%
  \tpIfProp{after-indent}{\global\@afterindenttrue}{\global\@afterindentfalse}%
  \tpIfProp{interline-para}
    {\global\setbox\@tempboxa\hbox{\@svsec}}
    {\global\setbox\@tempboxa\hbox{\ifvoid\@tempboxa\else\unhbox\@tempboxa\tpInterlineParaSep\fi\@svsec}}%
  \@nobreakfalse
  \global\@noskipsectrue
  \gdef\next{%
    \global\everypar{%
      \if@noskipsec
        \global\@noskipsecfalse
        {\setbox\z@\lastbox}%
        \clubpenalty\@M
        \begingroup \unhbox\@tempboxa \endgroup
        \unskip
        \hskip -\@tempskipa
      \else
        \clubpenalty \@clubpenalty
        \global\setbox\@tempboxa\box\voidb@x
        \everypar{}%
      \fi}%
    \ignorespaces
  }}

\def\tp@block@heading{%
  \@svsec
  \par \nobreak
  \tpIfProp{after-indent}{\global\@afterindenttrue}{\global\@afterindentfalse}%
  \gdef\next{%
    \vskip \@tempskipa
    \@afterheading}}

\def\tp@provide@hd@macros#1{%
  \tpProvideMacro{tp#1}{}{}{#1}%
  \tpProvideMacro{tpToc#1}{}{}{Toc#1}%
  \tpProvideMacro{tpRun#1}{}{}{Run#1}%
}

\def\heading{\@ifnextchar [{\@heading}{\@heading[]}}%]
\DeclareRobustCommand{\TitleBreak}{\hfill\break}

\def\@heading[#1]#2{%
  \tp@heading@reserve
  \tpParseAttributes{heading}{#1}%
  \edef\tp@heading@name{#2}%
  \tp@heading@load@props%
  \tp@provide@hd@macros{Author}%
  \tp@provide@hd@macros{Title}%
  \tp@provide@hd@macros{Subtitle}%
  \tp@provide@hd@macros{Number}%
  \tpProvideMacro{tpQuote}{}{}{Quote}%
  \tpProvideMacro{tpQuoteSource}{}{}{QuoteSource}%
}
\def\tp@heading@load@props{%
  \csname tp@heading@\tp@heading@name @properties\endcsname
}
\def\endheading{%
  \expandafter\ifx\csname tpUseHeading\tp@heading@name\endcsname\relax
    \PackageError{transpect.cls}{Heading level \tp@heading@name\space unknown!}{A Heading with level \tp@heading@name\space is unknown. Use the \string\tpDeclareHeading\space macro to declare heading levels.}%
  \else
    \afterfi\csname tpUseHeading\tp@heading@name\endcsname%
  \fi
  \tp@heading@reset
  \nopagebreak
}
\def\tp@heading@reserve{%
  \tpNamespace{heading}%
  \let\ltx@dbl@backslash\\
  \let\\\TitleBreak
  \let\ltx@label\label
  \let\tp@heading@label\relax
  \let\tp@notoc\@empty
}
\def\tp@heading@reset{%
  \let\tp@namespace\relax
  \let\\\ltx@dbl@backslash
  \let\label\ltx@label
  \let\tp@heading@name\relax
  \let\tp@heading@label\relax
  \let\tp@notoc\@empty
}








\endinput
%%
%% End of file `transpect-headings.sty'.
